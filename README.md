# Quantifying-SIM
Documentation of the simulations and computational analysis of the manuscript \
*Estimating mutation rates under heterogeneous stress responses* \
Lucy Lansch-Justen, Meriem El Karoui, Helen K. Alexander \
[bioRxiv 2023.09.05.555499](https://doi.org/10.1101/2023.09.05.555499).

The simulations and the inference algorithms are written in the programming language [julia verison 1.6](https://julialang.org/downloads/#long_term_support_release). 

## Reproducing the data in the manuscript
The data presented in the manuscript were generated by executing the functions
```
data_inference_manuscript()
data_supplementary_material()
```
in the `launcher_script.jl`. \
The raw figures from the manuscript were generated using the notebook `plots.ipynb`.

## Analysing experimental mutant count data

To analyise mutant count data from a pair of fluctuation assays under permissive/stressful conditions, use the script `inference.jl`. To set up, start julia and execute 
```
cd("...")
import Pkg
Pkg.activate("packages")
Pkg.instantiate()
include("inference.jl")
```
with the dots replaced again by the path to the repository.

### Estimation using the heterogeneous-response model

We developed a population dynamic model that considers within-population heterogeneity in stress responses in the form of a cell subpopulation with highly expressed stress response (response-on subpopulation) compared to the rest of the population with a low expression level (response-off subpopulation). The following function estimates mutation rates under this _heterogeneous-response_ model from fluctuation assay data
```
estimu_het(mc_p::Vector{Int}, Nf_p, mc_s::Vector{Int}, Nf_s, f_on, rel_div_on=0.; conf=false)
```

The input parameters are
* `mc_p`: Mutant counts under permissive condition (vector of integers)
* `Nf_p`: Average final population size under permissive condition
* `mc_s`: Mutant counts under stressful condition (vector of integers)
* `Nf_s`: Average final population size under stressful condition 
* `f_on`: Fraction of the response-on subpopulation (when known from a separate experimental measurement). Can be set as an inference parameter via `f_on->false`. 

Optional
* `rel_div_on=0.`: Relative division rate of response-on cells compared to response-off cells. By default `rel_div_on=0.` but can be set to a value measured in a separate experiment or set as an additional inference parameter via `rel_div_on->false`. For `rel_div_on=0.`, the fraction of response-on cells cannot be inferred. 
* `conf=false`: 95% confidence intervals are calculated using profile likelihood if `conf=true`.

The estimation output parameters are 
* Mutation rate of response-off cells with optional lower and upper bound of 95% confidence interval
* Mutation-supply ratio (mutational contribution of the response-on subpopulation compared to the one from the response-off subpopulation) with optional lower and upper bound of 95% confidence interval
* Fraction of response-on subpopulation with optional lower and upper bound of 95% confidence interval
* Fraction of the response-on subpopulation with optional lower and upper bound of 95% confidence interval
* Relative fitness of response-on cells with optional lower and upper bound of 95% confidence interval
* Mutation rate of response-on cells with optional lower and upper bound of 95% confidence interval
* Fold-change in population mean mutation rate with optional lower and upper bound of 95% confidence interval
* Log-likelihood, AIC and BIC value

If the inference fails, an infinte log-likelihood is returned. 

Note that, when the fraction of the response-on subpopulation is unknown and the relative division rate of response-on cells is set to zero, only the mutation rate of response-off cells, the mutation-supply ratio are estimated.

**Example** 

Under permissive conditions, the mutant counts 
```
mc_p = [0, 9, 3, 11, 0, 0, 1, 0, 3, 5, 1, 1, 2, 0, 0, 1, 89, 0, 1, 1]
```
and an average final population size of $10^8$ were observed. \
Under stressful conditions, the mutant counts 
```
mc_s = [2, 4, 0, 0, 0, 0, 0, 1, 2, 1, 0, 0, 2, 1, 0, 1, 1, 0, 0, 0]
```
and an average final population size of $1.6\cdot 10^7$ were observed. 

#### Case 1: An estimate of the fraction of the response-on subpopulation is available from a separate experiment

Let's consider the case that the fraction of cells with elevated stress response has been estimated to be around $\approx 5\%$. Then, evalutating the estimation function (by default, the relative division rate of response-on cells is set to zero)
```
estimu_het(mc_p, 10^8, mc_s, 1.6*10^7, 0.05)
```
yields the following output
```
   9.114768815186958e-9
   0.0
   0.0
   3.5240368441516403
   0.0
   0.0
   0.05
   0.05
   0.05
   0.0
   0.0
   0.0
   6.102948414822214e-7
   0.0
   0.0
  66.95670003888115
   0.0
   0.0
   4.297835001944057
   0.0
   0.0
  70.52804852447953
 145.05609704895906
 148.43385595718692
```
with an estimated mutation-rate increase of $\approx 67$-fold and increase in population mean mutation rate of $\approx 4.3$-fold. \
The relative division rate of response-on cells can also be set as an inference parameter and confidence intervals calculated via `conf=true`
```
estimu_het(mc_p, 10^8, mc_s, 1.6*10^7, 0.05, false, conf=true)
```
yielding
```
   8.96354137316273e-9
   5.017729879160309e-9
   1.4455547412285346e-8
   3.4494118026264484
   0.9501219966770496
   8.899112671542484
   0.05
   0.05
   0.05
   0.10937148503521901
   0.0
   0.8809381795575273
   5.874599627124421e-7
   2.0932026251154262e-7
   9.95302896627568e-7
  65.53882424990252
  18.05231793686394
 169.08314075930718
   4.2269412124951256
   1.852615896843197
   9.40415703796536
  70.4147871619212
 146.8295743238424
 151.8962126861842
```
i.e. an estimated mutation-rate increase of $\approx 66$-fold within $[18, 169]$, relative division rate of response-on cells of $\approx 0.11$ within $[0, 0.88]$ and increase in population mean mutation rate of $\approx 4.2$-fold within $[1.9, 9.4]$. However, this model version fits the data only slighlty better but has a higher AIC and BIC.

#### Case 2: The fraction of the response-on subpopulation is unknown

In this case, evaluating the estimation function (by default, the relative division rate of response-on cells is set to zero)

```
estimu_het(mc_p, 10^8, mc_s, 1.6*10^7, false, conf=true)
```
yields
```
   9.115114248990463e-9
   5.148319801620638e-9
   1.4595842504571983e-8
   3.523949513634336
   0.9728405943000181
   9.06288178068495
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
   0.0
  70.52804851770773
 145.05609703541546
 148.43385594364332
```
with an estimated mutation-supply ratio of $\approx 3.5$ within $[1.0, 9.1]$. \
Again, the relative division rate of response-on cells can be inferred.

### Estimation using the homogeneous-response model

We also implement the standard method using a _homogeneous-response_ model with optional differential mutant fitness. A novel estimation option is to constrain the mutant fitness to be equal under permissive and stressful conditions. 

The function 
```
function estimu_hom(mc_p::Vector{Int}, Nf_p, mc_s::Vector{Int}, Nf_s, fit_m=1.; conf=false)
```
estimates population-wide mutation rates from fluctuation assay data. \
The input parameters are
* `mc_p`: Mutant counts under permissive condition (vector of integers)
* `Nf_p`: Average final population size under permissive condition
* `mc_s`: Mutant counts under stressful condition (vector with integers)
* `Nf_s`: Average final population size under stressful condition

Optionally, the mutant fitness `fit_m` can be set to a value measured in a separate experiment, set as a joint, i.e. constrained to be equal under permissive and stressful conditions, inference parameter via `fit_m->false` or as two separate (input/inference) parameters given in a tuple. 

The estimation output parameters are 
* Mutation rate under permissive condition with optional lower and upper bound of 95% confidence interval
* Mutant fitness under permissive condition (relative to non-mutants) with optional lower and upper bound of 95% confidence interval
* Mutation rate under stressful condition with optional lower and upper bound of 95% confidence interval
* Mutant fitness under stressful condition (relative to non-mutants) with optional lower and upper bound of 95% confidence interval
* Fold-change in population mean mutation rate with optional lower and upper bound of 95% confidence interval
* Ratio of mutant fitness under stressful/permissive condition with optional lower and upper bound of 95% confidence interval 
* Log-likelihood, AIC and BIC value

From the inferred mutation rates, the increase in population mean mutation rate due to stress can be calculated.\
If the inference fails, an infinte log-likelihood is returned.

**Example (continued)** 

Evaluating the estimation function (by default, the mutant fitness is set to 1)
```
res = estimate_mu_hom(mc_p, 10^8, mc_s, 1.6*10^7)
```
yields the following output
```
   9.303451399702922e-9
   5.207224944431259e-9
   1.5014067349271478e-8
   1.0
   1.0
   1.0
   3.2249628930009825e-8
   1.5646884193559768e-8
   5.7454950175558495e-8
   1.0
   1.0
   1.0
   3.4664155854073275
   1.0421482619977054
  11.03369852247353
   1.0
   1.0
   1.0
  72.6520731303591
 149.3041462607182
 152.68190516894606
```
and an estimated increase in population mean mutation rate of $\approx 3.4$-fold within $[1.0, 11.0]$.

We can also consider a differential mutant fitness. If for exapmle, the mutant fitness under permissive conditions has been measured in a separate experiment to be $\approx 0.9$, but the mutant fitness under the stressful condition is unknown, evaluating the estimation function
```
estimu_hom(mc_p, 10^8, mc_s, 1.6*10^7, (0.9, false), conf=true)
```
which yields
```
   9.468025482861292e-9
   5.310363691470949e-9
   1.524759086707185e-8
   0.9
   0.9
   0.9
   3.873551784262921e-8
   1.8858128844965913e-8
   6.869020517362386e-8
   0.17638201337959866
   0.0
   0.7901637524013426
   4.091192816574794
   1.2367939964661072
  12.935122557415076
   0.19598001486622074
   0.0
   0.8779597248903807
  69.9510559327254
 145.9021118654508
 150.9687502277926
```
i.e. an estimated increase in population mean mutation rate of $\approx 4.1$-fold within $[1.2, 12.9]$ and mutant fitness under the stressful condition of $\approx 0.18$ within $[0, 0.79]$. This version of the model fits the data better, and AIC and BIC are lower. \
Alternatively, we can constrain the mutant fitness to be equal under permissive/stressful conditions via
```
estimu_hom(mc_p, 10^8, mc_s, 1.6*10^7, false, conf=true)
```
yielding 
```
   9.8036597534832e-9
   5.476942335763234e-9
   1.5835756407190256e-8
   0.7335750438503237
   0.4339987346781659
   1.2650348394292568
   3.3157793512695975e-8
   1.612923912536542e-8
   5.887668032833519e-8
   0.7335750438503237
   0.4339987346781659
   1.2650348394292568
   3.382185260041807
   1.6562678489568723
   6.006077875382082
   1.0
   1.0
   1.0
  72.01725415566455
 150.0345083113291
 155.1011466736709
```
with an estimated increase in population mean mutation rate of $\approx 3.4$-fold within $[1.7, 6.0]$ and a mutant fitness of $\approx 0.73$ within $[0.43, 1.27]$. However, this model version fits the data worse.
## Simulating fluctuation assays
